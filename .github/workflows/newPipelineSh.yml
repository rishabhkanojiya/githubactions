name: Individual Build Upload (Using Script)

on:
  workflow_dispatch:
    branches: [main]

  push:
    branches: [main]

defaults:
  run:
    working-directory: Dot.net.files.test.web
    # "defaults" and "working-directory: Dot.net.files.test.web" are used here so that the job can look in this folder for the "package.json" file.

jobs:
  build:
    name: Setup
    uses: ./.github/workflows/nodeBuild.yml

  css:
    name: Uploading CSS
    needs: build
    uses: ./.github/workflows/removeCopySh.yml
    with:
      args: "--exclude '*' --include 'css/*' ${{ needs.build.outputs.isDryrun == 'true' && '--dryrun' || ''}}"
      shouldRun: ${{ needs.build.outputs.isCss == 'true' }}
      version: ${{ needs.build.outputs.versionJson }}
      IS_PROD: "false"
      IS_RM: "true"
    secrets: inherit

  images:
    name: Uploading Images
    needs: build
    uses: ./.github/workflows/removeCopySh.yml
    with:
      args: "--exclude '*' --include 'images/*' ${{ needs.build.outputs.isDryrun == 'true' && '--dryrun' || ''}}"
      shouldRun: ${{ needs.build.outputs.isImage == 'true' }}
      version: ${{ needs.build.outputs.versionJson }}
      IS_PROD: "false"
    secrets: inherit

  translations:
    name: Uploading Translations
    needs: build
    uses: ./.github/workflows/removeCopySh.yml
    with:
      args: "--exclude '*' --include 'translations/*' ${{ needs.build.outputs.isDryrun == 'true' && '--dryrun' || ''}}"
      shouldRun: ${{ needs.build.outputs.isTrans == 'true' }}
      version: ${{ needs.build.outputs.versionJson }}
      IS_PROD: "false"
      IS_RM: "true"
    secrets: inherit

  configs:
    name: Uploading Configs
    needs: build
    uses: ./.github/workflows/removeCopySh.yml
    with:
      args: "--exclude '*' --include 'configs/*' ${{ needs.build.outputs.isDryrun == 'true' && '--dryrun' || ''}}"
      shouldRun: ${{ needs.build.outputs.isConfig == 'true' }}
      version: ${{ needs.build.outputs.versionJson }}
      IS_PROD: "false"
      IS_RM: "true"
    secrets: inherit

  javascript:
    name: Uploading Javascript Files
    needs: build
    uses: ./.github/workflows/removeCopySh.yml
    with:
      args: "--exclude '*' --include 'js/*' --include 'asset-manifest.json' --include 'static/*' ${{ needs.build.outputs.isDryrun == 'true' && '--dryrun' || ''}}"
      shouldRun: ${{ needs.build.outputs.isMain == 'true' }}
      version: ${{ needs.build.outputs.versionJson }}
      IS_PROD: "false"
      IS_RM: "true"
    secrets: inherit

  prodCss:
    name: Uploading CSS (Prod)
    needs: [build, css]
    if: ${{ needs.build.outputs.isDevOnly  == 'false' }}
    uses: ./.github/workflows/removeCopySh.yml
    with:
      args: "--exclude '*' --include 'css/*' ${{ needs.build.outputs.isDryrun == 'true' && '--dryrun' || ''}}"
      shouldRun: ${{ needs.css.result == 'success' }}
      version: ${{ needs.build.outputs.versionJson }}
      IS_PROD: "true"
      IS_RM: "true"
    secrets: inherit

  prodImages:
    name: Uploading Images (Prod)
    needs: [build, images]
    if: ${{ needs.build.outputs.isDevOnly  == 'false' }}
    uses: ./.github/workflows/removeCopySh.yml
    with:
      args: "--exclude '*' --include 'images/*' ${{ needs.build.outputs.isDryrun == 'true' && '--dryrun' || ''}}"
      shouldRun: ${{ needs.images.result == 'success' }}
      version: ${{ needs.build.outputs.versionJson }}
      IS_PROD: "true"
    secrets: inherit

  prodTranslations:
    name: Uploading Translations (Prod)
    needs: [build, translations]
    if: ${{ needs.build.outputs.isDevOnly  == 'false' }}
    uses: ./.github/workflows/removeCopySh.yml
    with:
      args: "--exclude '*' --include 'translations/*' ${{ needs.build.outputs.isDryrun == 'true' && '--dryrun' || ''}}"
      shouldRun: ${{ needs.translations.result == 'success' }}
      version: ${{ needs.build.outputs.versionJson }}
      IS_PROD: "true"
      IS_RM: "true"
    secrets: inherit

  prodConfigs:
    name: Uploading Configs Files (Prod)
    needs: [build, configs]
    if: ${{ needs.build.outputs.isDevOnly  == 'false' }}
    uses: ./.github/workflows/removeCopySh.yml
    with:
      args: "--exclude '*' --include 'configs/*' ${{ needs.build.outputs.isDryrun == 'true' && '--dryrun' || ''}}"
      shouldRun: ${{ needs.configs.result == 'success' }}
      version: ${{ needs.build.outputs.versionJson }}
      IS_RM: "true"
      IS_PROD: "true"
    secrets: inherit

  prodJavascript:
    name: Uploading Javascript Files (Prod)
    needs: [build, javascript]
    if: ${{ needs.build.outputs.isDevOnly  == 'false' }}
    uses: ./.github/workflows/removeCopySh.yml
    with:
      args: "--exclude '*' --include 'js/*' --include 'asset-manifest.json' --include 'static/*' ${{ needs.build.outputs.isDryrun == 'true' && '--dryrun' || ''}}"
      shouldRun: ${{ needs.javascript.result == 'success' }}
      version: ${{ needs.build.outputs.versionJson }}
      IS_PROD: "true"
      IS_RM: "true"
    secrets: inherit

  slackNotification:
    name: Slack Notification
    needs:
      [
        build,
        css,
        images,
        translations,
        configs,
        javascript,
        prodCss,
        prodImages,
        prodTranslations,
        prodConfigs,
        prodJavascript,
      ]
    if: ${{ always() && !cancelled() }}
    uses: ./.github/workflows/slackMessage.yml
    secrets: inherit
